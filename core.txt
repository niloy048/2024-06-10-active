aW1wb3J0IHRpbWUKaW1wb3J0IG9zCmltcG9ydCByZQppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCByZXF1ZXN0cwppbXBvcnQgcXVldWUKaW1wb3J0IGRhdGV0aW1lCmZyb20gZmxhc2sgaW1wb3J0IEZsYXNrCmZyb20gYnM0IGltcG9ydCBCZWF1dGlmdWxTb3VwCmZyb20gdXJsbGliLnBhcnNlIGltcG9ydCB1cmxqb2luCgpCT1RfTkFNRSA9IG9zLmVudmlyb24uZ2V0KCJCT1RfTkFNRSIsICJJbXMgTWFzdGVyIEJvdCIpCkJPVF9UT0tFTiA9IG9zLmVudmlyb24uZ2V0KCJCT1RfVE9LRU4iLCAiIikKQURNSU5fSURTID0gb3MuZW52aXJvbi5nZXQoIkFETUlOX0lEUyIsICIiKS5zcGxpdCgiLCIpClRBUkdFVF9HUk9VUF9JRCA9ICItMTAwMzY5Mjc4MzYwMiIKCkxPR0lOX1VSTCA9IG9zLmVudmlyb24uZ2V0KCJMT0dJTl9VUkwiLCAiIikKT1RQX1VSTCA9IG9zLmVudmlyb24uZ2V0KCJPVFBfVVJMIiwgIiIpCkxPR0lOX0hFQURFUlNfRU5WID0gb3MuZW52aXJvbi5nZXQoIkxPR0lOX0hFQURFUlMiLCAiIikKUEFORUxfVVNFUiA9IG9zLmVudmlyb24uZ2V0KCJQQU5FTF9VU0VSIiwgIiIpClBBTkVMX1BBU1MgPSBvcy5lbnZpcm9uLmdldCgiUEFORUxfUEFTUyIsICIiKQoKQ09MX01BUCA9IFtpbnQoaSktMSBmb3IgaSBpbiBvcy5lbnZpcm9uLmdldCgiQ09MX01BUFBJTkciLCAiMSwyLDMsNiIpLnNwbGl0KCIsIildCkNIRUNLX0RFTEFZID0gZmxvYXQob3MuZW52aXJvbi5nZXQoIkNIRUNLX0RFTEFZIiwgMS4wKSkKCklTX0ZJUlNUX1JVTiA9IFRydWUKT1RQX1FVRVVFID0gcXVldWUuUXVldWUoKQpQUk9DRVNTRURfT1RQX0NBQ0hFID0gc2V0KCkKQ0FDSEVfTE9DSyA9IHRocmVhZGluZy5Mb2NrKCkKCnRocmVhZHNfc3RhdHVzID0geyJjb2xsZWN0b3IiOiBOb25lLCAic2VuZGVyIjogTm9uZX0KCmFwcCA9IEZsYXNrKF9fbmFtZV9fKQoKQGFwcC5yb3V0ZSgnLycpCmRlZiBob21lKCk6CiAgICByZXR1cm4gZiJ7Qk9UX05BTUV9IFN0YXR1czogQWN0aXZlIgoKZGVmIG1hc2tfcGhvbmUocGhvbmUpOgogICAgaWYgbm90IHBob25lIG9yIGxlbihwaG9uZSkgPCA3OgogICAgICAgIHJldHVybiBwaG9uZQogICAgcmV0dXJuIGZIntwaG9uZVs6LTddfSoqKntwaG9uZVstNDpdfSIKCmRlZiBtZW1vcnlfY2xlYW5lcigpOgogICAgZ2xvYmFsIFBST0NFU1NFRF9PVFBfQ0FDSEUKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdGltZS5zbGVlcCg4NjQwMCkKICAgICAgICB3aXRoIENBQ0hFX0xPQ0s6CiAgICAgICAgICAgIFBST0NFU1NFRF9PVFBfQ0FDSEUuY2xlYXIoKQoKZGVmIHRlbGVncmFtX3dvcmtlcigpOgogICAgdGdfc2Vzc2lvbiA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgd2hpbGUgVHJ1ZToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1zZ19kYXRhID0gT1RQX1FVRVVFLmdldCgpCiAgICAgICAgICAgIGlmIG1zZ19kYXRhIGlzIE5vbmU6IGJyZWFrCiAgICAgICAgICAgIHBob25lLCBjb3VudHJ5LCBzZXJ2aWNlLCBvdHAsIGZ1bGxfbXNnID0gbXNnX2RhdGEKICAgICAgICAgICAgbWFza2VkX251bWJlciA9IG1hc2tfcGhvbmUocGhvbmUpCiAgICAgICAgICAgIG5vd191dGMgPSBkYXRldGltZS5kYXRldGltZS51dGNub3coKQogICAgICAgICAgICBiZF90aW1lID0gbm93X3V0YyArIGRhdGV0aW1lLnRpbWVkZWx0YShob3Vycz02KQogICAgICAgICAgICBmb3JtYXR0ZWRfdGltZSA9IGJkX3RpbWUuc3RyZnRpbWUoJyVZLSVtLSVkICVIOolNolMnKQogICAgICAgICAgICBmb3JtYXR0ZWRfdGV4dCA9IChmIuKchSB7Y291bnRyeX0gfCB7c2VydmljZX0gT1RQIFJlY2VpdmVkXG4iIGYiwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBwpSBcbiBcbiIgZiLwn5OxIDxiPk51bWJlcjo8L2I+IHttYXNrZWRfbnVtYmVyfVxuIiBmIvCfkpUgPGI+T1RQIENvZGU6PC9iPiB7b3RwfVxuIiBmIvCfnp8IDxiPlNlcnZpY2U6PC9iPiB7c2VydmljZX1cbiIgZiLwn4yNIDxiPkNvdW50cnk6PC9iPiB7Y291bnRyeX1cbiIgZiLwnpDAIDxiPlRpbWU6PC9iPiB7Zm9ybWF0dGVkX3RpbWV9XG5cbiIgZiLwn5K8IDxiPk1lc3NhZ2U6PC9iPlxuIiBmIjxibG9ja3F1b3RlPntmdWxsX21zZ308L2Jsb2NrcXVvdGU+IikKICAgICAgICAgICAgdXJsID0gZiJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e0JPVF9UT0tFTn0vc2VuZE1lc3NhZ2UiCiAgICAgICAgICAgIHBheWxvYWQgPSB7ImNoYXRfaWQiOiBUQVJHRVRfR1JPVVBfSUQsICJ0ZXh0IjogZm9ybWF0dGVkX3RleHQsICJwYXJzZV9tb2RlIjogIkhUTUwifQogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgcmVzID0gdGdfc2Vzc2lvbi5wb3N0KHVybCwganNvbj1wYXlsb2FkLCB0aW1lb3V0PTEwKQogICAgICAgICAgICAgICAgaWYgcmVzLnN0YXR1c19jb2RlID09IDQyOToKICAgICAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHJlcy5qc29uKCkuZ2V0KCdwYXJhbWV0ZXJzJywge30pLmdldCgncmV0cnlfYWZ0ZXInLCAzKSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgdGltZS5zbGVlcCgwLjUpCiAgICAgICAgICAgIE9UUF9RVUVVRS50YXNrX2RvbmUoKQogICAgICAgIGV4Y2VwdDogdGltZS5zbGVlcCgxKQoKZGVmIHNlbmRfdGVsZWdyYW0obXNnLCBwYXJzZV9tb2RlPSJIVE1MIik6CiAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7Qk9UX1RPS0VOfS9zZW5kTWVzc2FnZSIKICAgIGZvciBhZG1pbiBpbiBBRE1JTl9JRFM6CiAgICAgICAgdHJ5OiByZXF1ZXN0cy5wb3N0KHVybCwganNvbj17ImNoYXRfaWQiOiBhZG1pbiwgInRleHQiOiBtc2csICJwYXJzZV9tb2RlIjogcGFyc2VfbW9kZX0sIHRpbWVvdXQ9MTApCiAgICAgICAgZXhjZXB0OiBwYXNzCgpkZWYgc2VuZF9hZG1pbl9sb2cobXNnKToKICAgIG5vd191dGMgPSBkYXRldGltZS5kYXRldGltZS51dGNub3coKQogICAgYmRfdGltZSA9IG5vd191dGMgKyBkYXRldGltZS50aW1lZGVsdGEoaG91cnM9NikKICAgIHRfc3RyID0gYmRfdGltZS5zdHJmdGltZSgnJUg6JU06JVMnKQogICAgZm9ybWF0dGVkX21zZyA9IGYi4o2iIDxiPntCT1RfTkFNRX0gU1lTVEVNIExPRzwvYj5cbiB7bXNnfVxuIPCdkMggYHt0X3N0cn1gIgogICAgc2VuZF9hZG1pbl9sb2cobXNnKQoKZGVmIHNlbmRfZXJyb3JfdGVsZWdyYW0oYWN0aW9uX2ZhaWxlZCwgcmVhc29uLCB0YXJnZXQpOgogICAgbXNnID0gKGYi4p2YIDxiPntCT1RfTkFNRX0gQUxFUlQ8L2I+XG4iIGYi4p2NIEFjdGlvbiBGYWlsZWQ6IHthY3Rpb25fZmFpbGVkfVxuIiBmIuOqssyOIFRhcmdldDoge3RhcmdldH1cbiIgZiLilaEgUmVhc29uOiB7cmVhc29ufVxuIikKICAgIHNlbmRfdGVsZWdyYW0obXNnKQoKQ09VU5UUllfRU1PSklTID0geyJBZmdoYW5pc3RhbiI6ICLwn4em8J+HryIsICJCYW5nbGFkZXNoIjogIvCfh6fwn4euIn0KCmRlZiBnZXRfZW1vamkoY291bnRyeV90ZXh0KToKICAgIGZvciBjLCBlIGluIENPVU5UUllfRU1PSklTLml0ZW1zKCk6CiAgICAgICAgaWYgYy5sb3dlcigpIGluIGNvdW50cnlfdGV4dC5sb3dlcigpOiByZXR1cm4gZlwie2N9IHtifVwiCiAgICByZXR1cm4gY291bnRyeV90ZXh0LnNwbGl0KClbMF0gaWYgY291bnRyeV90ZXh0IGVsc2UgIlVua25vd24iCgpkZWYgc29sdmVfbWF0aChodG1sKToKICAgIG1hdGNoID0gcmUuc2VhcmNoKHInKFxkKylccypbKy1dXHMqKFxkKyknLCBodG1sKQogICAgaWYgbWF0Y2g6CiAgICAgICAgbjEsIG9wLCBuMiA9IGludChtYXRjaC5ncm91cCgxKSksIG1hdGNoLmdyb3VwKDIpLCBpbnQobWF0Y2guZ3JvdXAoMykpCiAgICAgICAgcmV0dXJuIHN0cihuMSArIG4yIGlmIG9wID09ICcrJyBlbHNlIG4xIC0gbjIpCiAgICByZXR1cm4gTm9uZQoKZGVmIGV4dHJhY3Rfb3RwKG1lc3NhZ2UpOgogICAgbXNnX3N0ciA9IHN0cihtZXNzYWdlKQogICAgbWF0Y2hlcyA9IHJlLmZpbmRhbGwocicvYlxkezQsMTB9XGIvYlxkezMsNX1bLVxzXVxkezMsNX1cYicsIG1zZ19zdHIpCiAgICBpZiBtYXRjaGVzOiByZXR1cm4gbWF0Y2hlc1swXS5yZXBsYWNlKCIgIiwgIiIpLnJlcGxhY2UoIi0iLCAiIikKICAgIG1hdGNoX2ZhbGxiYWNrID0gcmUuc2VhcmNoKHInXGR7Myx9JywgbXNnX3N0cikKICAgIHJldHVybiBtYXRjaF9mYWxsYmFjay5ncm91cCgwKSBpZiBtYXRjaF9mYWxsYmFjayBlbHNlICJOL0EiCgpkZWYgcGFyc2VfZW52X2hlYWRlcnMoKToKICAgIGhlYWRlcnMgPSB7IlVzZXItQWdlbnQiOiAiTW96aWxsYS81LjAifQogICAgaWYgbm90IExPR0lOX0hFQURFUlNfRU5WOiByZXR1cm4gaGVhZGVycywgTm9uZQogICAgY2xlYW5fdXJsID0gTm9uZQogICAgcmV0dXJuIGhlYWRlcnMsIGNsZWFuX3VybAoKZGVmIHJ1bl9lbmdpbmUoKToKICAgIHdoaWxlIFRydWU6CiAgICAgICAgc2Vzc2lvbiA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzX2dldCA9IHNlc3Npb24uZ2V0KExPR0lOX1VSTCwgdGltZW91dD0xNSkKICAgICAgICAgICAgc291cCA9IEJlYXV0aWZ1bFNvdXAocmVzX2dldC50ZXh0LCAnaHRtbC5wYXJzZXInKQogICAgICAgICAgICBmb3JtID0gc291cC5maW5kKCdmb3JtJykKICAgICAgICAgICAgZmluYWxfdXJsID0gdXJsam9pbihMT0dJTl9VUkwsIGZvcm0uZ2V0KCdhY3Rpb24nKSkgaWYgZm9ybSBlbHNlIExPR0lOX1VSTAogICAgICAgICAgICBwYXlsb2FkID0ge30KICAgICAgICAgICAgaWYgZm9ybToKICAgICAgICAgICAgICAgIGZvciBpbnAgaW4gZm9ybS5maW5kX2FsbCgnaW5wdXQnKToKICAgICAgICAgICAgICAgICAgICBuID0gaW5wLmdldCgnbmFtZScpCiAgICAgICAgICAgICAgICAgICAgaWYgbiogcGF5bG9hZFtuXSA9IGlucC5nZXQoJ3ZhbHVlJywgJycpCiAgICAgICAgICAgIHBvc3RfcmVzID0gc2Vzc2lvbi5wb3N0KGZpbmFsX3VybCwgZGF0YT1wYXlsb2FkLCB0aW1lb3V0PTE1KQogICAgICAgICAgICBpZiBwb3N0X3Jlcy5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICB3aGlsIFRydWU6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICByID0gc2Vzc2lvbi5nZXQoT1RQX1VSTCwgdGltZW91dD0xMCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgImxvZ2luIiBpbiByLnVybDogYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgcmF3ID0gW10KICAgICAgICAgICAgICAgICAgICAgICAgc291cF9vdHAgPSBCZWF1dGlmdWxTb3VwKHIudGV4dCwgJ2h0bWwucGFyc2VyJykKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHRyIGluIHNvdXBfb3RwLnNlbGVjdCgidGFibGUgdHIiKVsxOl06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjID0gW3RkLmdldF90ZXh0KHNlcGFyYXRvcj0iICIsIHN0cmlwPVRydWUpIGZvciB0ZCBpbiB0ci5maW5kX2FsbCgidGQiKV0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGM6IHJhdy5hcHBlbmQoYykKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHJvdyBpbiByYXdbOjotMV06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaG9uZSA9IHN0cihyb3dbQ09MX01BUFswXV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cgPSBzdHIocm93W0NPTF9NQVBbM11dKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RwID0gZXh0cmFjdF9vdHAobXNnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gZlwie3Bob25lfV97b3RwfVwiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIENBQ0hFX0xPQ0s6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYga2V5IG5vdCBpbiBQUk9DRVNTRURfT1RQX0NBQ0hFOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQUk9DRVNTRURfT1RQX0NBQ0hFLmFkZChrZXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9UUF9RVUVVRS5wdXQoKHBob25lLCAiR0xPQkFMIiwgIlNSViIsIG90cCwgbXNnKSkKICAgICAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKENIRUNLX0RFTEFZKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogdGltZS5zbGVlcCgzKQogICAgICAgIGV4Y2VwdDogdGltZS5zbGVlcCg1KQogICAgICAgIGZpbmFsbHk6IHNlc3Npb24uY2xvc2UoKQoKZGVmIHRocmVhZF9zdXBlcnZpc29yKCk6CiAgICB3aGlsZSBUcnVlOgogICAgICAgIGlmIG5vdCB0aHJlYWRzX3N0YXR1c1siY29sbGVjdG9yIl0gb3Igbm90IHRocmVhZHNfc3RhdHVzWyJjb2xsZWN0b3IiXS5pc19hbGl2ZSgpOgogICAgICAgICAgICB0ID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9cnVuX2VuZ2luZSwgZGFlbW9uPVRydWUpCiAgICAgICAgICAgIHQuc3RhcnQoKTsgdGhyZWFkc19zdGF0dXNbImNvbGxlY3RvciJdID0gdAogICAgICAgIGlmIG5vdCB0aHJlYWRzX3N0YXR1c1sic2VuZGVyIl0gb3Igbm90IHRocmVhZHNfc3RhdHVzWyJzZW5kZXIiXS5pc19hbGl2ZSgpOgogICAgICAgICAgICB0ID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9dGVsZWdyYW1fd29ya2VyLCBkYWVtb249VHJ1ZSkKICAgICAgICAgICAgdC5zdGFydCgpOyB0aHJlYWRzX3N0YXR1c1sic2VuZGVyIl0gPSB0CiAgICAgICAgdGltZS5zbGVlcCg1KQoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIHRocmVhZGluZy5UaHJlYWQodGFcmdldD1tZW1vcnlfY2xlYW5lciwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgIHRocmVhZGluZy5UaHJlYWQodGFcmdldD10aHJlYWRfc3VwZXJ2aXNvciwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgIGFwcC5ydW4oaG9zdD0nMC4wLjAuMCcsIHBvcnQ9aW50KG9zLmVudmlyb24uZ2V0KCJQT1JUIiwgNTAwMCkpKQo=
